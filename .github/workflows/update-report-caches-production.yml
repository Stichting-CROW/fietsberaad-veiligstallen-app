name: Daily cache update (Production)

on:
  schedule:
    # Run daily at 03:00 UTC
    - cron: "0 3 * * *"
  # Allow manual triggering from GitHub Actions UI
  workflow_dispatch:
    inputs:
      from_date:
        description: 'Optional: Start date in ISO format (e.g., 2025-10-16T00:00:00.000Z). If not provided, uses current date.'
        required: false
        type: string

jobs:
  update-cache:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Call update-cache endpoint
        id: call
        run: |
          set -e
          RESP=$(mktemp)
          
          # Build API URL from NEXTAUTH_URL (home page URL)
          BASE_URL="${PROD_NEXTAUTH_URL%/}"  # Remove trailing slash if present
          UPDATE_CACHE_URL="${BASE_URL}/api/protected/database/update-cache"
          
          # Build curl command with bearer token
          CURL_CMD="curl -sS -w \"%{http_code}\" -o \"$RESP\""
          
          # Add Authorization header with bearer token
          if [ -n "$PROD_CACHE_UPDATE_BEARER_TOKEN" ]; then
            CURL_CMD="$CURL_CMD -H \"Authorization: Bearer $PROD_CACHE_UPDATE_BEARER_TOKEN\""
          else
            echo "::error title=Missing token::PROD_CACHE_UPDATE_BEARER_TOKEN secret is not configured"
            exit 1
          fi
          
          # Add optional 'from' parameter (defaults to current date if not set)
          FROM_PARAM=""
          if [ -n "$FROM_DATE" ]; then
            FROM_PARAM="?from=$(echo -n "$FROM_DATE" | jq -sRr @uri)"
          fi
          
          HTTP_CODE=$(eval "$CURL_CMD \"$UPDATE_CACHE_URL$FROM_PARAM\"")
          
          echo "http_code=$HTTP_CODE" >> "$GITHUB_OUTPUT"
          
          # Extract and display summary text if available
          if command -v jq >/dev/null 2>&1; then
            SUMMARY=$(jq -r '.logEntry.summaryText // .summaryText // empty' "$RESP" 2>/dev/null || echo "")
            if [ -n "$SUMMARY" ]; then
              echo "## Cache Update Summary (Production)" >> "$GITHUB_STEP_SUMMARY"
              echo "\`\`\`" >> "$GITHUB_STEP_SUMMARY"
              echo "$SUMMARY" >> "$GITHUB_STEP_SUMMARY"
              echo "\`\`\`" >> "$GITHUB_STEP_SUMMARY"
            else
              echo "No summary text available in response" >> "$GITHUB_STEP_SUMMARY"
            fi
            
            # Also extract success status
            SUCCESS=$(jq -r '.success // false' "$RESP" 2>/dev/null || echo "false")
            echo "success=$SUCCESS" >> "$GITHUB_OUTPUT"
          fi
          
          # Persist the full JSON response for debugging (base64 encoded to avoid delimiter issues)
          if [ -s "$RESP" ]; then
            RESPONSE_B64=$(base64 -w 0 < "$RESP" || base64 < "$RESP")
            echo "response_b64=$RESPONSE_B64" >> "$GITHUB_OUTPUT"
          else
            echo "response_b64=" >> "$GITHUB_OUTPUT"
          fi
          
        env:
          PROD_CACHE_UPDATE_BEARER_TOKEN: ${{ secrets.PROD_CACHE_UPDATE_BEARER_TOKEN }}
          PROD_NEXTAUTH_URL: ${{ vars.PROD_NEXTAUTH_URL }}
          FROM_DATE: ${{ inputs.from_date }}
          
      - name: Evaluate result
        run: |
          HTTP_CODE="${{ steps.call.outputs.http_code }}"
          SUCCESS="${{ steps.call.outputs.success }}"
          
          case "$HTTP_CODE" in
            200)
              if [ "$SUCCESS" = "true" ]; then
                echo "✅ All caches updated successfully (Production)"
              else
                echo "⚠️ HTTP 200 but success=false in response body"
                exit 1
              fi
              ;;
            207)
              echo "::error title=Partial cache update failure::One or more caches failed to update. See step summary for details."
              exit 1
              ;;
            400)
              echo "::error title=Bad request::Invalid request parameters. Check the 'from' date format."
              exit 1
              ;;
            401)
              echo "::error title=Unauthorized::Authentication required. Check PROD_CACHE_UPDATE_BEARER_TOKEN secret."
              exit 1
              ;;
            500)
              echo "::error title=Server error::Unexpected server error occurred."
              exit 1
              ;;
            *)
              echo "::error title=Unexpected HTTP code::HTTP $HTTP_CODE"
              exit 1
              ;;
          esac
          
      - name: Display full response (on failure)
        if: failure()
        run: |
          echo "## Full API Response" >> "$GITHUB_STEP_SUMMARY"
          echo "\`\`\`json" >> "$GITHUB_STEP_SUMMARY"
          RESPONSE_B64="${{ steps.call.outputs.response_b64 }}"
          if [ -n "$RESPONSE_B64" ]; then
            echo "$RESPONSE_B64" | base64 -d >> "$GITHUB_STEP_SUMMARY" 2>/dev/null || echo "Failed to decode response" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "No response available" >> "$GITHUB_STEP_SUMMARY"
          fi
          echo "\`\`\`" >> "$GITHUB_STEP_SUMMARY"

